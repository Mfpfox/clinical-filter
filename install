#!/usr/bin/make -f

PREFIX                  := /software/ddd/internal/clinical-filter
GIT_URI                 := ssh://git.internal.sanger.ac.uk/repos/git/ddd/clinical-filter.git
CLINICAL_FILTER_VERSION :=

TMPDIR                  := $(shell mktemp -d)
SRCDIR                  := $(TMPDIR)/clinical-filter-$(CLINICAL_FILTER_VERSION)

CLINICAL_FILTER_PREFIX  := $(PREFIX)/clinical-filter-$(CLINICAL_FILTER_VERSION)

INSTALL                 := /usr/bin/install
CHMOD                   := Du=rwx,Dg=rwx,Do=rx,Fu=rw,Fg=rw,Fo=r

usage:
	@echo "Usage: install CLINICAL_FILTER_VERSION=XXX clinicalfilter" >&2

clinicalfilter: $(SRCDIR)
	test -n "$(CLINICAL_FILTER_VERSION)"
	$(MAKE) -C $< -f install TMPDIR=$(TMPDIR) CLINICAL_FILTER_VERSION=$(CLINICAL_FILTER_VERSION) clean-srcdir-git install-python

$(SRCDIR): $(TMPDIR)/clinical-filter-$(CLINICAL_FILTER_VERSION).zip
	cd $(TMPDIR) && unzip $<

$(TMPDIR)/clinical-filter-$(CLINICAL_FILTER_VERSION).zip:
	git archive --format zip --output $(TMPDIR)/clinical-filter-$(CLINICAL_FILTER_VERSION).zip --remote $(GIT_URI) --prefix clinical-filter-$(CLINICAL_FILTER_VERSION)/ $(CLINICAL_FILTER_VERSION)

clean-srcdir-git:
	find $(SRCDIR)/src/main/ | grep "/\.gitignore"$ | xargs -I '{}' rm {}

install-python:
	rsync -rp --chmod=$(CHMOD) $(SRCDIR)/src/main/python/ $(CLINICAL_FILTER_PREFIX)


